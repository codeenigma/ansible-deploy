---

- hosts: "localhost"
  tasks:
    - name: Ensure deploy scripts are up to date.
      git:
        repo: "{{ ansible_deploy.own_repository | default('https://github.com/codeenigma/ansible-deploy.git')}}"
        dest: "{{ playbook_dir | dirname }}"
        update: yes
        version: "{{ ansible_deploy.own_repository_branch | default('master') }}"

    - name: Ensure config directory is up to date.
      git:
        repo: "{{ ansible_deploy.config_repository }}"
        dest: "{{ playbook_dir | dirname }}/config"
        version: "{{ ansible_deploy.config_repository_branch  | default('master') }}"
      when: ansible_deploy.config_repository

    - name: Ensure /etc/ansible/hosts is a directory.
      file:
        path: "/etc/ansible/hosts"
        state: directory
        force: yes
      when: not ansible_deploy.config_repository

    - name: Add default Ansible config.
      copy:
        src: ansible.cfg
        dest: /etc/ansible/ansible.cfg
      when: not ansible_deploy.config_repository

    - name: Symlink config folders to /etc/ansible.
      file:
        dest: "/etc/ansible/{{ item }}"
        src: "{{ playbook_dir | dirname }}/config/{{ item }}"
        state: link
        force: yes
      with_items:
        - hosts
        - group_vars
        - facts.d
      when: ansible_deploy.config_repository

    - name: Add custom Ansible config.
      file:
        src: "{{ playbook_dir | dirname }}/config/ansible.cfg"
        dest: /etc/ansible/ansible.cfg
        state: link
        force: yes
      when: ansible_deploy.config_repository

    - name: Symlink our roles.
      file:
        src: "{{ playbook_dir | dirname }}/roles"
        dest: /etc/ansible/roles
        state: link
        force: yes

    - name: Create data dir.
      file:
        path: /etc/ansible/data
        state: directory