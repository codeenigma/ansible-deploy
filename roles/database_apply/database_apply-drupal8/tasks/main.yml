---

- name: Fix file permissions for settings.php.
  file:
    state: file
    path: "{{ deploy_path }}/{{ webroot }}/sites/{{ site.folder }}/settings.php"
    owner: "{{ www_user }}"
    group: "{{ www_user }}"
  become: yes
  with_items: "{{ drupal.sites }}"
  loop_control:
    loop_var: site
  when: 
    - www_user != deploy_user
    - previous_build_number == 0

- name: Install Drupal.
  command:
    cmd: "{{ drush_bin }} -y si"
    chdir: "{{ deploy_path }}/{{ webroot }}/sites/{{ site.folder }}"
  become: "{{ 'no' if www_user == deploy_user else 'yes' }}"
  become_user: "{{ www_user }}"
  with_items: "{{ drupal.sites }}"
  loop_control:
    loop_var: site
  when: previous_build_number == 0


# - name: Fix file permissions for public files.
#   file:
#     state: directory
#     path: "{{ build_public_file_path }}"
#     recurse: yes
#     owner: "{{ www_user }}"
#     group: "{{ www_user }}"
#   become: yes
#   when: www_user != deploy_user

# - name: Fix file permissions for private files.
#   file:
#     state: directory
#     path: "{{ build_private_file_path }}"
#     recurse: yes
#     owner: "{{ www_user }}"
#     group: "{{ www_user }}"
#   become: yes
#   when: www_user != deploy_user

- name: Apply Drupal database updates.
  command:
    cmd: "{{ drush_bin }} -y updb"
    chdir: "{{ deploy_path }}/{{ webroot }}/sites/{{ site.folder }}"
  become: "{{ 'no' if www_user == deploy_user else 'yes' }}"
  become_user: "{{ www_user }}"
  with_items: "{{ drupal.sites }}"
  loop_control:
    loop_var: site
  when: previous_build_number == 0